import { NextRequest, NextResponse } from "next/server";
import prisma from "@/lib/prisma";
import { requireDietitian, AuthResult } from "@/lib/api-auth";
import { addCorsHeaders, handleCors } from "@/lib/cors";

// Force dynamic rendering
export const dynamic = 'force-dynamic';

export const GET = requireDietitian(
  async (request: NextRequest, auth: AuthResult) => {
    try {
      const searchParams = request.nextUrl.searchParams;
      const mealType = searchParams.get("mealType");

      console.log(
        "üì• Preset request",
        JSON.stringify({
          mealType,
          dietitianId: auth.user?.id,
          url: request.nextUrl.pathname,
        })
      );

      const whereClause: any = {
        isActive: true,
        dietitianId: auth.user!.id, // SECURITY: Only show own presets
      };

      if (mealType) {
        whereClause.mealType = mealType;
      }

      const presets = await prisma.mealPreset.findMany({
        where: whereClause,
        include: {
          items: {
            orderBy: {
              order: "asc",
            },
          },
        },
        orderBy: [
          { patternScore: "desc" }, // Auto-generated with high score first
          { usageCount: "desc" }, // Then by usage
          { createdAt: "desc" },
        ],
      });

      console.log(
        "‚úÖ Preset response",
        JSON.stringify({
          count: presets.length,
          mealType,
        })
      );

      return addCorsHeaders(NextResponse.json(presets));
    } catch (error) {
      console.error("Error fetching presets:", error);
      return addCorsHeaders(
        NextResponse.json(
          { error: "Preset'ler y√ºklenirken bir hata olu≈ütu" },
          { status: 500 }
        )
      );
    }
  }
);

export const POST = requireDietitian(
  async (request: NextRequest, auth: AuthResult) => {
    // Handle CORS preflight
    const corsResponse = handleCors(request);
    if (corsResponse) return corsResponse;

    try {
      const body = await request.json();
      const { name, mealType, items } = body;

      if (!name) {
        return addCorsHeaders(
          NextResponse.json({ error: "Preset adƒ± zorunludur" }, { status: 400 })
        );
      }

      const preset = await prisma.mealPreset.create({
        data: {
          name: name.trim(),
          mealType: mealType || null,
          isAutoGenerated: false,
          isActive: true,
          dietitianId: auth.user!.id, // SECURITY: Assign to authenticated dietitian
          items: {
            create: (items || []).map((item: any, idx: number) => ({
              besinName: item.besinName || item.besin,
              miktar: item.miktar || "",
              birim: item.birim || "",
              order: idx,
            })),
          },
        },
        include: {
          items: true,
        },
      });

      return addCorsHeaders(NextResponse.json(preset, { status: 201 }));
    } catch (error) {
      console.error("Error creating preset:", error);
      return addCorsHeaders(
        NextResponse.json(
          { error: "Preset olu≈üturulurken bir hata olu≈ütu" },
          { status: 500 }
        )
      );
    }
  }
);
